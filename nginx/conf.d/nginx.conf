server {
  # Listen for HTTP traffic on port 80
  listen 80;
  # Catch-all server (matches any Host header if nothing more specific exists)
  server_name _;

  # ===== Frontend static files =====
  # This is where the built frontend (dist/build) is mounted inside the container
  root /usr/share/nginx/html;
  # When a directory is requested (e.g. "/"), return index.html
  index index.html;

  # ===== Request body size limit =====
  # Maximum allowed body size (uploads, JSON, etc.)
  # If exceeded → Nginx returns 413 before the request reaches the app.
  # NOTE to future self: 2g is huge; adjust to real project requirements.
  client_max_body_size 2g;

  # ===== API proxying =====
  # All requests starting with /api/ are forwarded to the backend container "app"
  location /api/ {
    # IMPORTANT for future self:
    # Because proxy_pass ends with /api/, Nginx preserves the remainder of the path:
    #   /api/users → http://app:8080/api/users
    proxy_pass http://app:8080/api/;

    # Pass useful headers to the backend
    proxy_set_header Host $host;                # Original Host header
    proxy_set_header X-Forwarded-Proto $scheme; # http/https scheme
    proxy_set_header X-Forwarded-For $remote_addr; # Client IP address
    proxy_set_header X-Request-Id $request_id;      # Unique request ID for tracing

    # Return the request ID to the client as well, so logs match
    add_header X-Request-Id $request_id;

    # IMPORTANT for large file uploads/downloads:
    # - Do not buffer request body on disk/memory; stream directly to backend
    proxy_request_buffering off;
    # - Do not buffer backend responses; stream directly to client
    proxy_buffering off;

    # Allow long-running backend operations (reports, large files, etc.)
    proxy_read_timeout 600s;
  }

  # ===== Frontend assets (CSS/JS/images) =====
  location /assets/ {
    # Try to serve the file directly; if it doesn't exist → 404
    # (No SPA fallback here — assets must be real files)
    try_files $uri =404;

    # Tell the browser it can cache these files for 30 days
    expires 30d;
    # "immutable" means filenames never change (usually they have hashes),
    # so the browser won't revalidate them
    add_header Cache-Control "public, immutable";
  }

  # ===== Swagger / OpenAPI =====
  # Redirect old /swagger-ui.html to the correct location
  location = /swagger-ui.html {
    return 301 /swagger-ui/index.html;
  }

  # Forward all /swagger-ui/... requests directly to the backend
  # ^~ = stop searching for more specific locations once this matches
  location ^~ /swagger-ui/ {
    proxy_pass http://app:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $remote_addr;
  }

  # Proxy OpenAPI 3 JSON docs (/v3/api-docs*)
  location ^~ /v3/api-docs {
    proxy_pass http://app:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $remote_addr;
  }

  # ===== SPA fallback =====
  # Everything not matched above falls into this block
  location / {
    # If the requested file exists → serve it
    # Otherwise → return /index.html for SPA routing (React/Vue/Angular/etc.)
    try_files $uri /index.html;
  }
}
